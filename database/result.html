---
layout: database
title: The result set | Opis Database
keywords: php, database, abstraction, query builder, schema builder
description: Learn how to handle the result set
active: result
---
<h1><strong>The result set</strong></h1>

<p>
    Every time we query a database using the <code>select</code> method,
    instead of returning an array of results, <strong>Opis Database</strong> returns an
    instance of the <code>Opis\Database\ResultSet</code> class.
    By doing so, <strong>Opis Database</strong> allows us to have greater control over how the results will be further handled.
</p>
<p>
    Using the <code>all</code> method is perfectly fine when we are dealing with reasonable data sets, but
    we can quickly run out of memory if we are dealing with large data sets. This is because the <code>all</code>
    method transfer all the results from the database into PHP's memory and stores them into an array.
    One solution to avoid going out of memory when dealing with large data sets is to iterate through the
    entire result set and process one result at a time.
</p>

{% highlight php startinline %}
$result = $db->from('users')
             ->select(array('name', 'email'));
             
while(false !== $user = $result->next())
{
    echo $user->name, $user->email;
}
{% endhighlight %}

{% include subtitle.html anchor="Options" value="Fetching options" %}

<p>
    By default the results of a query are fetched as anonymous objects with property names
    that correspond to the column names returned in your result set.
    You can change this behavior by using a set of methods provided by the <code>Opid\Database\ResultSet</code>
    class.
</p>

<p>
    Fetching records as an array indexed by column name is done using the <code>fetchAssoc</code> method.
</p>

{% highlight php startinline %}
$result = $db->from('users')
             ->select(array('name', 'email'))
             ->fetchAssoc()
             ->all();
             
foreach($result as $user)
{
    echo $user['name'], $user['email'];
}

{% endhighlight %}

<p>
    Fetching records as an array indexed by column number, starting at column 0, is done using the
    <code>fetchNum</code> method.
</p>

{% highlight php startinline %}
$result = $db->from('users')
             ->select(array('name', 'email'))
             ->fetchNum()
             ->all();
             
foreach($result as $user)
{
    echo $user[0], $user[1];
}

{% endhighlight %}

<p>
    The <code>fetchBoth</code> method fetch each record as an array indexed by both column name and column number.
</p>

{% highlight php startinline %}
$result = $db->from('users')
             ->select(array('name', 'email'))
             ->fetchBoth()
             ->all();
             
foreach($result as $user)
{
    //prints name and email
    echo $user['name'], $user[1];
}

{% endhighlight %}
<p>
    The <code>fetchNamed</code> method is similar to <code>fetchAssoc</code> method, except that if there are
    multiple columns with the same name, the value referred to by that key will be an array of all the values
    in the row that had that column name.
</p>
<p>
    You can map the columns of the result set to named properties in a custom class by using the <code>fetchClass</code> method.
    The method accepts as arguments a class name and optionally an array of arguments that will be
    passed to the class constructor.
</p>
<p class="well text-danger">
    <strong><span class="fa fa-exclamation-triangle"></span> Important!</strong>
    The named properties of your class that will be mapped to column names must have <code>public</code> access.
</p>

{% highlight php startinline %}
class User
{
    public $name;
    public $email;
    
    public function test()
    {
        echo $this->name, $this->email;
    }
}

$result = $db->from('users')
             ->select(array('name', 'email'))
             ->fetchClass('User')
             ->all();
             
foreach($result as $user)
{
    $user->test();
}

{% endhighlight %}

{% include subtitle.html anchor="Callbacks" value="Callback functions" %}

<p>
    <strong>Opis Database</strong> allows you to specify a callback function that can be
    passed as an argument to the <code>all</code> and the <code>first</code> methods.
    Records are mapped to the result of calling the callback function using each row's
    columns as parameters in the call.
</p>

{% highlight php startinline %}
class User
{
    protected $name;
    protected $email;
    
    public function __construct($name, $email)
    {
        $this->name = $name;
        $this->email = $email;
    }
    
    public function getName()
    {
        return $this->name;
    }
    
    public function getEmail()
    {
        return $this->email;
    }
    
    public function sendEmail($subject, $message)
    {
        mail($this->email, $subject, $message);
    }
    
}

$result = $db->from('users')
             ->select(array('name', 'email'))
             ->all(function($name, $email){
                return new User($name, $email);
             });

$message = "Opis Database is great! http://www.opis.io/database";
             
foreach($result as $user)
{
    $subject = "Hello " . $user->getName();
    $user->sendEmail($subject, $message);
}

{% endhighlight %}

<p class="well text-primary">
    <strong><span class="fa fa-pencil"></span> TODO:</strong>
    Provide more detailed examples about how to handle the result set of a query.
</p>

{% include pager.html back="/database/select.html" next="/database/filter.html" %}